<html>
  <head>
    <title>Kohr</title>
    <link rel="icon" href="https://cdn.discordapp.com/attachments/682997526676373521/712225425656643594/favicon.ico" />
    <script src="/socket.io/socket.io.js"></script>
    <script src="//code.jquery.com/jquery-3.2.1.min.js"></script>
    <link href="https://fonts.googleapis.com/css?family=Inconsolata:400,700&display=swap&subset=latin-ext" rel="stylesheet">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="/css/utility">
    <link rel="stylesheet" type="text/css" href="/css/login">
    <link rel="stylesheet" type="text/css" href="/css/game">
    <link rel="stylesheet" type="text/css" href="/css/lobby">
    <script type="text/javascript" src="/js/landscape"></script>
  </head>
  <body id="body">

    <div id="cache-frame" hidden>
      <img id="cache-blue_pawn" width="500" height="500" src="/piece/blue_pawn">
      <img id="cache-blue_enchanter" width="500" height="500" src="/piece/blue_enchanter">
      <img id="cache-blue_rook" width="500" height="500" src="/piece/blue_rook">
      <img id="cache-blue_knight" width="500" height="500" src="/piece/blue_knight">
      <img id="cache-blue_bishop" width="500" height="500" src="/piece/blue_bishop">
      <img id="cache-blue_queen" width="500" height="500" src="/piece/blue_queen">
      <img id="cache-red_pawn" width="500" height="500" src="/piece/red_pawn">
      <img id="cache-red_enchanter" width="500" height="500" src="/piece/red_enchanter">
      <img id="cache-red_rook" width="500" height="500" src="/piece/red_rook">
      <img id="cache-red_knight" width="500" height="500" src="/piece/red_knight">
      <img id="cache-red_bishop" width="500" height="500" src="/piece/red_bishop">
      <img id="cache-red_queen" width="500" height="500" src="/piece/red_queen">
    </div>

    <div id="disconnected-frame">
      <h1 id="disconnected-title" class="noSelect">._.</h1>
      <p id="load-font" class="noSelect">loading</p>
    </div>

    <div id="landscape-frame" hidden>
      <h1 id="landscape-title" class="noSelect">Tourne ton écran zebi !</h1>
    </div>

    <div id="login-frame" hidden>
      <h1 id="login-title" class="noSelect">Bienvenue sur Kohr !</h1>
      <form id="login-background">
        <label id="login-label" class="noSelect">Pseudo :<input id="login-pseudo-input" autocomplete="off" placeholder="Jean-Kévin"/></label>
        <input id="login-submit-fullscreen" class="login-submit" value="C'est parti !" type="submit"/>
        <input id="login-submit-normal" class="login-submit" value="Jouer sans plein écran" type="submit"/>
      </form>
    </div>
    
    <div id="lobby-frame" hidden>
      <h1 id="lobby-title" class="noSelect">Partie : </h1>
      <p id="lobby-gamemode" class="noSelect">Mode : </p>
      <p id="lobby-player-list-label" class="noSelect">Joueurs</p>
      <ul id="lobby-action-list"></ul>
      <ul id="lobby-player-list"></ul>
    </div>

    <div id="game-frame" hidden>
      <div id="game-board">
        <div id="game-base-side">
          <button class="game-buttons" id="game-base-change-board">Voir le Kohr</button>
          <canvas class="game-canvas" id="game-base-canvas"></canvas>
          <div class="game-energybar" id="game-base-energybar">
            <img class="game-energybar-under" src="/img/energybar_under"/>
            <div class="game-energybar-energy"></div>
            <img class="game-energybar-above" src="/img/energybar_above"/>
          </div>
        </div>
        <div id="game-kohr-side">
          <button class="game-buttons" id="game-kohr-change-board">Voir la Base</button>
          <canvas class="game-canvas" id="game-kohr-canvas"></canvas>
          <div class="game-energybar" id="game-kohr-energybar">
            <img class="game-energybar-under" src="/img/energybar_under"/>
            <div class="game-energybar-energy"></div>
            <img class="game-energybar-above" src="/img/energybar_above"/>
          </div>
        </div>
      </div>
    </div>

    <script>
      $(document).ready(function() {
        var socket = io();
        var pseudo = "#-1";
        selected = {unselect:true,x:1,y:1,atMiddle:true}
        var showPlayButtons = false
        var game = {}
        var imageOffsets = {}
        imageOffsets["Pawn"] = [0,25]
        imageOffsets["Enchanter"] = [0,25]
        imageOffsets["Knight"] = [0,25]
        imageOffsets["Rook"] = [0,25]
        imageOffsets["Bishop"] = [0,25]
        imageOffsets["Queen"] = [0,25]
        var imageScales = {}
        imageScales["Pawn"] = 2
        imageScales["Enchanter"] = 2
        imageScales["Knight"] = 2
        imageScales["Rook"] = 2
        imageScales["Bishop"] = 2
        imageScales["Queen"] = 2

        
        $('#login-background').on('submit', function(e){
          e.preventDefault();
        });

        $('.login-submit').on('click', function(){
          var enteredPseudo = $("#login-pseudo-input").val().trim()
          setLandscape(false)
          if(pseudo == "#-1"){
            document.location.reload(false);
          }
          if(/^[a-z0-9àäâéèëêïîôûùç\-_]*/i.test(enteredPseudo)){
            socket.emit("joinSession",{pseudo : enteredPseudo, tempName : pseudo});
            pseudo = enteredPseudo
            if(this.id == "login-submit-fullscreen"){
              var body = document.getElementById("body")
              if (body.requestFullscreen) {
                body.requestFullscreen();
              } else if (body.webkitRequestFullscreen) { /* Safari */
                body.webkitRequestFullscreen();
              } else if (body.msRequestFullscreen) { /* IE11 */
                body.msRequestFullscreen();
              }
            }
          }
          else{
            alert("Pseudo invalid !")
          }
        })

        $(".game-buttons").on("click",function(){
          var buttonId = $(this).attr("id")
          var buttonBoard = buttonId.slice(5,9) //kohr or base
          var buttonType = buttonId.slice(10)
          if(buttonType == "change-board"){
            if(buttonBoard == 'base'){
              $("#game-board").css("left", "-100%");
            }else{
              $("#game-board").css("left", "0%");
            }
          }
        })

        $(".game-canvas").on("click",function(e){
          var parentOffset = $(this).offset(); 
          var clickX = e.pageX - parentOffset.left;
          var clickY = e.pageY - parentOffset.top;
          var maxHeight = parseInt($("#game-frame").css("height"))
          var maxWidth = parseInt($("#game-frame").css("width"))
          var canvasHeight = parseInt($(this).css("height"))
          var canvasWidth = parseInt($(this).css("width"))
          var gridHeight = Math.min(maxHeight, maxWidth/2)
          if($(this).attr("id") == "game-base-canvas"){
            grid = 0.5*game.gameInfo.maxPlayers + 3
            selected.atMiddle = false
          }else{
            grid = game.gameInfo.maxPlayers + 5
            selected.atMiddle = true
          }
          var m = gridHeight / (1.3*grid)
          var clickX = clickX - 2*m
          var clickY = clickY - m
          var relX = clickX / (canvasWidth - 4*m)
          var relY = clickY / (canvasHeight - 2*m)
          var isoX = relY + relX - 0.5
          var isoY = 1 - (relY - relX + 0.5)
          var coordX = Math.floor(isoX*grid+1)
          var coordY = Math.floor(isoY*grid+1)
          if(coordX > 0 && coordX <= grid && coordY > 0 && coordY <= grid){
            selected.unselect = false
            selected.x = coordX
            selected.y = coordY
          }else{
            selected.unselect = true
          }
          let tempMe = game.players.find(player => player.pseudo == pseudo)
          if(tempMe == undefined){
            console.log("oula4")
            return
          }
          let play = (tempMe.team == game.gameInfo.teamPlaying)
          showGame(game,pseudo,selected,play)
        });

        function showGame(givenGame,userPseudo,userSelected,canPlay){
          //SHOW THE GAME
          $("#lobby-frame").attr("hidden",true);
          $("#game-frame").attr("hidden",false);

          //SET ENERGY HEIGHT TO FIT THE BAR
          $(".game-energybar").css("height",$(".game-energybar-under").first().css("height"))

          //GET PLAYER TEAM
          var tempMe = givenGame.players.find(player => player.pseudo == userPseudo)
          if(tempMe == undefined){
            console.log("oula")
            return givenGame
          }
          var userTeam = tempMe.team

          //SET ENERGY BAR
          var energy = givenGame.stats[userTeam][0]
          var allWidth = parseInt($(".game-energybar-under").css("width"))
          var roundSize = parseInt($(".game-energybar-energy").css("height"))/2 + "px"
          if(energy == 0){
            var energyWidth = 0
            $(".game-energybar-energy").css("border-radius","0px")
          }else if(energy < 16){
            var energyWidth = (8*allWidth/100) + energy*(6*allWidth/100)
            $(".game-energybar-energy").css("border-radius",roundSize + " 0px 0px " + roundSize)
          }else{
            var energyWidth = allWidth
            $(".game-energybar-energy").css("border-radius",roundSize)
          }
          $(".game-energybar-energy").css("width",energyWidth + "px")

          //GET CANVAS AND DEFINE LIMITING DIMENSION
          var baseCanvas = document.getElementById("game-base-canvas")
          var kohrCanvas = document.getElementById("game-kohr-canvas")
          var maxHeight = parseInt($("#game-frame").css("height"))
          var maxWidth = parseInt($("#game-frame").css("width"))
          var gridHeight = Math.min(maxHeight, maxWidth/2)
          var gridWidth = gridHeight * 2
          baseCanvas.height = gridHeight
          baseCanvas.width = gridWidth
          kohrCanvas.height = gridHeight
          kohrCanvas.width = gridWidth

          //CALCULATE GRID, M AND CELL FOR BASE AND KOHR
          var baseGrid = 0.5*givenGame.gameInfo.maxPlayers + 3
          var baseM = gridHeight / (1.3*baseGrid)
          var kohrGrid = givenGame.gameInfo.maxPlayers + 5
          var kohrM = gridHeight / (1.3*kohrGrid)
          var baseHeightCell = ((gridHeight - (2*baseM)) / 2) / baseGrid
          var baseWidthCell = ((gridWidth - (4*baseM)) / 2) / baseGrid
          var kohrHeightCell = ((gridHeight - (2*kohrM)) / 2) / kohrGrid
          var kohrWidthCell = ((gridWidth - (4*kohrM)) / 2) / kohrGrid
          var baseCtx = baseCanvas.getContext("2d");
          var kohrCtx = kohrCanvas.getContext("2d");

          //DRAW SELECTED SQUARE
          if(!userSelected.unselect){
            if(userSelected.atMiddle){
              kohrCtx.fillStyle = '#3c5050';
              kohrCtx.beginPath();
              let leftPointX = (2*kohrM) + ((userSelected.x-1)*kohrWidthCell) + ((userSelected.y-1)*kohrWidthCell)
              let leftPointY = (gridHeight/2) + ((userSelected.x-1)*kohrHeightCell) - ((userSelected.y-1)*kohrHeightCell)
              kohrCtx.moveTo(leftPointX,leftPointY);
              kohrCtx.lineTo(leftPointX+kohrWidthCell,leftPointY-kohrHeightCell);
              kohrCtx.lineTo(leftPointX+2*kohrWidthCell,leftPointY);
              kohrCtx.lineTo(leftPointX+kohrWidthCell,leftPointY+kohrHeightCell);
              kohrCtx.closePath();
              kohrCtx.fill();
            }else{
              baseCtx.fillStyle = '#3c5050';
              baseCtx.beginPath();
              let leftPointX = (2*baseM) + ((userSelected.x-1)*baseWidthCell) + ((userSelected.y-1)*baseWidthCell)
              let leftPointY = (gridHeight/2) + ((userSelected.x-1)*baseHeightCell) - ((userSelected.y-1)*baseHeightCell)
              baseCtx.moveTo(leftPointX,leftPointY);
              baseCtx.lineTo(leftPointX+baseWidthCell,leftPointY-baseHeightCell);
              baseCtx.lineTo(leftPointX+2*baseWidthCell,leftPointY);
              baseCtx.lineTo(leftPointX+baseWidthCell,leftPointY+baseHeightCell);
              baseCtx.closePath();
              baseCtx.fill();
            }
          }

          //DRAW BASE GRID
          baseCtx.strokeStyle = "#6e6e91"
          baseCtx.lineCap = "round";
          baseCtx.lineWidth = 4;
          var xS = (gridWidth - (4*baseM)) / 2
          var yS = 0
          var xE = (gridWidth - (4*baseM))
          var yE = (gridHeight - (2*baseM)) / 2
          for(let i = 0; i <= baseGrid; i++){
            baseCtx.moveTo(xS+2*baseM,yS+baseM)
            baseCtx.lineTo(xE+2*baseM,yE+baseM)
            baseCtx.stroke()
            xS -= baseWidthCell
            yS += baseHeightCell
            xE -= baseWidthCell
            yE += baseHeightCell
          }
          var xS = 0
          var yS = (gridHeight - (2*baseM)) / 2
          var xE = (gridWidth - (4*baseM)) / 2
          var yE = 0
          for(let i = 0; i <= baseGrid; i++){
            baseCtx.moveTo(xS+2*baseM,yS+baseM)
            baseCtx.lineTo(xE+2*baseM,yE+baseM)
            baseCtx.stroke()
            xS += baseWidthCell
            yS += baseHeightCell
            xE += baseWidthCell
            yE += baseHeightCell
          }

          //DRAW KOHR GRID
          kohrCtx.strokeStyle = "#6e6e91"
          kohrCtx.lineCap = "round";
          kohrCtx.lineWidth = 4;
          var xS = (gridWidth - (4*kohrM)) / 2
          var yS = 0
          var xE = (gridWidth - (4*kohrM))
          var yE = (gridHeight - (2*kohrM)) / 2
          for(let i = 0; i <= kohrGrid; i++){
            kohrCtx.moveTo(xS+2*kohrM,yS+kohrM)
            kohrCtx.lineTo(xE+2*kohrM,yE+kohrM)
            kohrCtx.stroke()
            xS -= kohrWidthCell
            yS += kohrHeightCell
            xE -= kohrWidthCell
            yE += kohrHeightCell
          }
          var xS = 0
          var yS = (gridHeight - (2*kohrM)) / 2
          var xE = (gridWidth - (4*kohrM)) / 2
          var yE = 0
          for(let i = 0; i <= kohrGrid; i++){
            kohrCtx.moveTo(xS+2*kohrM,yS+kohrM)
            kohrCtx.lineTo(xE+2*kohrM,yE+kohrM)
            kohrCtx.stroke()
            xS += kohrWidthCell
            yS += kohrHeightCell
            xE += kohrWidthCell
            yE += kohrHeightCell
          }

          //DRAW PIECES
          for (index in givenGame.pieces){
            piece = givenGame.pieces[index]
            pieceImage = new Image()
            if(piece.team == userTeam){
              var color = "blue"
            }else{
              var color = "red"
            }
            var pieceImage = document.getElementById("cache-" + color + "_" + piece.type.toLowerCase())
            var pieceX = piece.x - 1
            var pieceY = piece.y - 1
            if(userTeam == 1){
              var pieceX = -pieceX + givenGame.gameInfo.maxPlayers + 4
              var pieceY = -pieceY + givenGame.gameInfo.maxPlayers + 4
            }
            let imageSize = (kohrHeightCell/250) * imageScales[piece.type] * 500
            let x = (2*kohrM + kohrWidthCell) + (pieceX*kohrWidthCell) + (pieceY*kohrWidthCell)
            let y = (gridHeight/2) + (pieceX*kohrHeightCell) - (pieceY*kohrHeightCell)
            kohrCtx.drawImage(pieceImage, x + imageOffsets[piece.type][0] - imageSize/2, y + imageOffsets[piece.type][1] - imageSize, imageSize, imageSize);
          }

          console.log(givenGame)
          return givenGame
        }

        socket.on("disconnect",function(){
          $("#disconnected-frame").attr("hidden",false);
          $("#login-frame").attr("hidden",true);
        });

        socket.on("fatalError",function(data){
          alert("Fatal error : " + data.text)
          document.location.reload(true);
        })
        
        socket.on("logError",function(data){
          console.log("Warning : " + data.text)
        })

        socket.on("showError",function(data){
          alert(data.text)
        })

        socket.on("leaveSession",function(data){
          document.location.reload(true);
        })

        socket.on("setTempName",function(data){
          pseudo = data.tempName
          $("#disconnected-frame").attr("hidden",true);
          $("#login-frame").attr("hidden",false);
        });

        socket.on("showLobby",function(data){
          $("#lobby-title").text(data.gameInfo.name)
          $("#lobby-gamemode").text("Mode : " + data.gameInfo.maxPlayers/2 + "vs" + data.gameInfo.maxPlayers/2)
          $("#lobby-player-list-label").text("Joueurs " + data.players.length + "/" + data.gameInfo.maxPlayers)
          $("#lobby-player-list").empty()
          $("#lobby-action-list").empty()
          for(var player of data.players){
            if(player.pseudo == pseudo){
              $("#lobby-player-list").append("<li class='lobby-players'>" + player.pseudo + " (" + data.gameInfo.teamNames[player.team] + ")<input value='Quitter' type='button' class='lobby-player-kick-buttons' id='lobby-actions-" + player.pseudo + "'/><input value=\"Changer d'équipe\" type='button' class='lobby-player-team-buttons' id='lobby-actions-" + player.pseudo + "'/></li>")
            }else if(data.asMaster){
              $("#lobby-player-list").append("<li class='lobby-players'>" + player.pseudo + " (" + data.gameInfo.teamNames[player.team] + ")<input value='Kick' type='button' class='lobby-player-kick-buttons' id='lobby-actions-" + player.pseudo + "'/><input value=\"Changer d'équipe\" type='button' class='lobby-player-team-buttons' id='lobby-actions-" + player.pseudo + "'/></li>")
            }else{
              $("#lobby-player-list").append("<li class='lobby-players'>" + player.pseudo + " (" + data.gameInfo.teamNames[player.team] + ")</li>")
            }
          }
          if(data.asMaster){
            $("#lobby-action-list").append("<input type='button' class='lobby-actions' id='lobby-action-change-mode' value='Changer de mode'/>")
            $("#lobby-action-list").append("<br/>")
            $("#lobby-action-list").append("<br/>")
            $("#lobby-action-list").append("<input type='button' class='lobby-actions' id='lobby-action-start-game' value='Lancer !'/>")
            $("#lobby-action-list").append("<br/>")
            $("#lobby-action-list").append("<br/>")
          }
          $(".lobby-player-kick-buttons").click(function(){
            var actionOnPseudo = $(this).attr("id").slice(14)
            socket.emit("playerKick",{pseudoToKick : actionOnPseudo});
          })
          $(".lobby-player-team-buttons").click(function(){
            var actionOnPseudo = $(this).attr("id").slice(14)
            socket.emit("playerSwitchTeam",{pseudoToSwitch : actionOnPseudo});
          })
          $("#lobby-action-change-mode").click(function(){
            socket.emit("gameChangeMode");
          })
          $("#lobby-action-start-game").click(function(){
            socket.emit("gameStart");
          })
          $("#login-frame").attr("hidden",true);
          $("#lobby-frame").attr("hidden",false);
        });
        
        socket.on("showGamePlay",function(data){
          game = showGame(data,pseudo,selected,true)
        })
        
        socket.on("showGameWait",function(data){
          game = showGame(data,pseudo,selected,false)
        })
        
      });

    </script>
  </body>
</html>
