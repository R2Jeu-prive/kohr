<html>
  <head>
    <title>Kohr</title>
    <link rel="icon" href="https://cdn.discordapp.com/attachments/682997526676373521/712225425656643594/favicon.ico" />
    <script src="/socket.io/socket.io.js"></script>
    <script src="//code.jquery.com/jquery-3.2.1.min.js"></script>
    <link href="https://fonts.googleapis.com/css?family=Inconsolata:400,700&display=swap&subset=latin-ext" rel="stylesheet">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="/css/utility">
    <link rel="stylesheet" type="text/css" href="/css/login">
    <link rel="stylesheet" type="text/css" href="/css/game">
    <link rel="stylesheet" type="text/css" href="/css/lobby">
    <script type="text/javascript" src="/js/landscape"></script>
  </head>
  <body id="body">

    <div id="disconnected-frame">
      <h1 id="disconnected-title" class="noSelect">._.</h1>
      <p id="load-font" class="noSelect">loading</p>
    </div>

    <div id="landscape-frame" hidden>
      <h1 id="landscape-title" class="noSelect">Tourne ton écran zebi !</h1>
    </div>

    <div id="login-frame" hidden>
      <h1 id="login-title" class="noSelect">Bienvenue sur Kohr !</h1>
      <form id="login-background">
        <label id="login-label" class="noSelect">Pseudo :<input id="login-pseudo-input" autocomplete="off" placeholder="Jean-Kévin"/></label>
        <input id="login-submit-fullscreen" class="login-submit" value="C'est parti !" type="submit"/>
        <input id="login-submit-normal" class="login-submit" value="Jouer sans plein écran" type="submit"/>
      </form>
    </div>
    
    <div id="lobby-frame" hidden>
      <h1 id="lobby-title" class="noSelect">Partie : </h1>
      <p id="lobby-gamemode" class="noSelect">Mode : </p>
      <p id="lobby-player-list-label" class="noSelect">Joueurs</p>
      <ul id="lobby-action-list"></ul>
      <ul id="lobby-player-list"></ul>
    </div>

    <div id="game-frame" hidden>
      <div id="game-board">
        <div id="game-base-side">
          <button class="game-buttons" id="game-base-change-board">Voir le Kohr</button>
          <canvas class="game-canvas" id="game-base-canvas"></canvas>
          <div class="game-energybar" id="game-base-energybar">
            <img class="game-energybar-under" src="/img/energybar_under"/>
            <div class="game-energybar-energy"></div>
            <img class="game-energybar-above" src="/img/energybar_above"/>
          </div>
        </div>
        <div id="game-kohr-side">
          <button class="game-buttons" id="game-kohr-change-board">Voir la Base</button>
          <canvas class="game-canvas" id="game-kohr-canvas"></canvas>
          <div class="game-energybar" id="game-kohr-energybar">
            <img class="game-energybar-under" src="/img/energybar_under"/>
            <div class="game-energybar-energy"></div>
            <img class="game-energybar-above" src="/img/energybar_above"/>
          </div>
        </div>
      </div>
    </div>

    <script>
      $(document).ready(function() {
        var socket = io();
        var pseudo = "#-1";
        var selected = {x:0,y:0,atMiddle:true}
        var showPlayButtons = false
        var game = {}

        
        $('#login-background').on('submit', function(e){
          e.preventDefault();
        });

        $('.login-submit').on('click', function(){
          var enteredPseudo = $("#login-pseudo-input").val().trim()
          setLandscape(false)
          if(pseudo == "#-1"){
            document.location.reload(false);
          }
          if(/^[a-z0-9àäâéèëêïîôûùç\-_]*/i.test(enteredPseudo)){
            socket.emit("joinSession",{pseudo : enteredPseudo, tempName : pseudo});
            pseudo = enteredPseudo
            if(this.id == "login-submit-fullscreen"){
              var body = document.getElementById("body")
              if (body.requestFullscreen) {
                body.requestFullscreen();
              } else if (body.webkitRequestFullscreen) { /* Safari */
                body.webkitRequestFullscreen();
              } else if (body.msRequestFullscreen) { /* IE11 */
                body.msRequestFullscreen();
              }
            }
          }
          else{
            alert("Pseudo invalid !")
          }
        })

        $(".game-buttons").on("click",function(){
          var buttonId = $(this).attr("id")
          var buttonBoard = buttonId.slice(5,9) //kohr or base
          var buttonType = buttonId.slice(10)
          if(buttonType == "change-board"){
            if(buttonBoard == 'base'){
              $("#game-board").css("left", "-100%");
            }else{
              $("#game-board").css("left", "0%");
            }
          }
        })

        function showGame(givenGame,userPseudo,userSelected,canPlay){
          $("#lobby-frame").attr("hidden",true);
          $("#game-frame").attr("hidden",false);

          $(".game-energybar").css("height",$(".game-energybar-under").first().css("height"))
          //GET PLAYER TEAM
          var tempMe = givenGame.players.find(player => player.pseudo == userPseudo)
          if(tempMe == undefined){
            console.log("oula")
            return givenGame
          }
          var userTeam = tempMe.team
          //DRAW CANVAS
          var baseCanvas = document.getElementById("game-base-canvas")
          var kohrCanvas = document.getElementById("game-kohr-canvas")
          var maxHeight = parseInt($("#game-frame").css("height"))
          var maxWidth = parseInt($("#game-frame").css("width"))
          var gridHeight = Math.min(maxHeight, maxWidth/2)
          var gridWidth = gridHeight * 2
          var m = 10
          baseCanvas.height = gridHeight
          baseCanvas.width = gridWidth
          kohrCanvas.height = gridHeight
          kohrCanvas.width = gridWidth

          //BASE CANVAS
          var baseCtx = baseCanvas.getContext("2d");
          baseCtx.strokeStyle = "#6e6e91"
          baseCtx.lineCap = "round";
          baseCtx.lineWidth = 4;
          grid = 4
          baseHeightCell = ((gridHeight - (2*m)) / 2) / grid
          baseWidthCell = ((gridWidth - (2*m)) / 2) / grid
          var xS = (gridWidth - (2*m)) / 2
          var yS = 0
          var xE = (gridWidth - (2*m))
          var yE = (gridHeight - (2*m)) / 2
          for(let i = 0; i <= grid; i++){
            baseCtx.moveTo(xS+m,yS+m)
            baseCtx.lineTo(xE+m,yE+m)
            baseCtx.stroke()
            xS -= baseWidthCell
            yS += baseHeightCell
            xE -= baseWidthCell
            yE += baseHeightCell
          }
          var xS = 0
          var yS = (gridHeight - (2*m)) / 2
          var xE = (gridWidth - (2*m)) / 2
          var yE = 0
          for(let i = 0; i <= grid; i++){
            baseCtx.moveTo(xS+m,yS+m)
            baseCtx.lineTo(xE+m,yE+m)
            baseCtx.stroke()
            xS += baseWidthCell
            yS += baseHeightCell
            xE += baseWidthCell
            yE += baseHeightCell
          }

          //KOHR CANVAS
          var kohrCtx = kohrCanvas.getContext("2d");
          kohrCtx.strokeStyle = "#6e6e91"
          kohrCtx.lineCap = "round";
          kohrCtx.lineWidth = 4;
          grid = 9
          kohrHeightCell = ((gridHeight - (2*m)) / 2) / grid
          kohrWidthCell = ((gridWidth - (2*m)) / 2) / grid
          var xS = (gridWidth - (2*m)) / 2
          var yS = 0
          var xE = (gridWidth - (2*m))
          var yE = (gridHeight - (2*m)) / 2
          for(let i = 0; i <= grid; i++){
            kohrCtx.moveTo(xS+m,yS+m)
            kohrCtx.lineTo(xE+m,yE+m)
            kohrCtx.stroke()
            xS -= kohrWidthCell
            yS += kohrHeightCell
            xE -= kohrWidthCell
            yE += kohrHeightCell
          }
          var xS = 0
          var yS = (gridHeight - (2*m)) / 2
          var xE = (gridWidth - (2*m)) / 2
          var yE = 0
          for(let i = 0; i <= grid; i++){
            kohrCtx.moveTo(xS+m,yS+m)
            kohrCtx.lineTo(xE+m,yE+m)
            kohrCtx.stroke()
            xS += kohrWidthCell
            yS += kohrHeightCell
            xE += kohrWidthCell
            yE += kohrHeightCell
          }
          for (index in givenGame.pieces){
            piece = givenGame.pieces[index]
            console.log(piece)
            if(true){ //piece.team == userTeam
              pieceImage = new Image()
              pieceImage.src = "piece/blue_" + piece.constructor.name.toLowerCase()
              console.log(pieceImage.src)
              pieceImage.onload = function(){
                let x = kohrWidthCell + piece.x*kohrWidthCell + piece.y*kohrWidthCell
                let y = ((gridHeight - (2*m))/2) - (piece.x*kohrHeightCell) + (piece.y*kohrHeightCell)
                //kohrCtx.drawImage(pieceImage, x, y);
                kohrCtx.fillRect(x,y,5,5)
              }
            }
          }
          console.log(givenGame)
          return givenGame
        }

        socket.on("disconnect",function(){
          $("#disconnected-frame").attr("hidden",false);
          $("#login-frame").attr("hidden",true);
        });

        socket.on("fatalError",function(data){
          alert("Fatal error : " + data.text)
          document.location.reload(true);
        })
        
        socket.on("logError",function(data){
          console.log("Warning : " + data.text)
        })

        socket.on("showError",function(data){
          alert(data.text)
        })

        socket.on("leaveSession",function(data){
          document.location.reload(true);
        })

        socket.on("setTempName",function(data){
          pseudo = data.tempName
          $("#disconnected-frame").attr("hidden",true);
          $("#login-frame").attr("hidden",false);
        });

        socket.on("showLobby",function(data){
          $("#lobby-title").text(data.gameInfo.name)
          $("#lobby-gamemode").text("Mode : " + data.gameInfo.maxPlayers/2 + "vs" + data.gameInfo.maxPlayers/2)
          $("#lobby-player-list-label").text("Joueurs " + data.players.length + "/" + data.gameInfo.maxPlayers)
          $("#lobby-player-list").empty()
          $("#lobby-action-list").empty()
          for(var player of data.players){
            if(player.pseudo == pseudo){
              $("#lobby-player-list").append("<li class='lobby-players'>" + player.pseudo + " (" + data.gameInfo.teamNames[player.team] + ")<input value='Quitter' type='button' class='lobby-player-kick-buttons' id='lobby-actions-" + player.pseudo + "'/><input value=\"Changer d'équipe\" type='button' class='lobby-player-team-buttons' id='lobby-actions-" + player.pseudo + "'/></li>")
            }else if(data.asMaster){
              $("#lobby-player-list").append("<li class='lobby-players'>" + player.pseudo + " (" + data.gameInfo.teamNames[player.team] + ")<input value='Kick' type='button' class='lobby-player-kick-buttons' id='lobby-actions-" + player.pseudo + "'/><input value=\"Changer d'équipe\" type='button' class='lobby-player-team-buttons' id='lobby-actions-" + player.pseudo + "'/></li>")
            }else{
              $("#lobby-player-list").append("<li class='lobby-players'>" + player.pseudo + " (" + data.gameInfo.teamNames[player.team] + ")</li>")
            }
          }
          if(data.asMaster){
            $("#lobby-action-list").append("<input type='button' class='lobby-actions' id='lobby-action-change-mode' value='Changer de mode'/>")
            $("#lobby-action-list").append("<br/>")
            $("#lobby-action-list").append("<br/>")
            $("#lobby-action-list").append("<input type='button' class='lobby-actions' id='lobby-action-start-game' value='Lancer !'/>")
            $("#lobby-action-list").append("<br/>")
            $("#lobby-action-list").append("<br/>")
          }
          $(".lobby-player-kick-buttons").click(function(){
            var actionOnPseudo = $(this).attr("id").slice(14)
            socket.emit("playerKick",{pseudoToKick : actionOnPseudo});
          })
          $(".lobby-player-team-buttons").click(function(){
            var actionOnPseudo = $(this).attr("id").slice(14)
            socket.emit("playerSwitchTeam",{pseudoToSwitch : actionOnPseudo});
          })
          $("#lobby-action-change-mode").click(function(){
            socket.emit("gameChangeMode");
          })
          $("#lobby-action-start-game").click(function(){
            socket.emit("gameStart");
          })
          $("#login-frame").attr("hidden",true);
          $("#lobby-frame").attr("hidden",false);
        });
        
        socket.on("showGamePlay",function(data){
          game = showGame(data,pseudo,selected,true)
        })
        
        socket.on("showGameWait",function(data){
          game = showGame(data,pseudo,selected,false)
        })
        
      });

    </script>
  </body>
</html>
