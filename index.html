<html>
  <head>
    <title>Kohr</title>
    <link rel="icon" href="https://cdn.discordapp.com/attachments/682997526676373521/712225425656643594/favicon.ico" />
    <script src="/socket.io/socket.io.js"></script>
    <script src="//code.jquery.com/jquery-3.2.1.min.js"></script>
    <link href="https://fonts.googleapis.com/css?family=Inconsolata:400,700&display=swap&subset=latin-ext" rel="stylesheet">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="/css/utility">
    <link rel="stylesheet" type="text/css" href="/css/login">
    <link rel="stylesheet" type="text/css" href="/css/game">
    <link rel="stylesheet" type="text/css" href="/css/lobby">
    <script type="text/javascript" src="/js/landscape"></script>
  </head>
  <body id="body">

    <div id="disconnected-frame">
      <h1 id="disconnected-title" class="noSelect">._.</h1>
      <p id="load-font" class="noSelect">loading</p>
    </div>

    <div id="login-frame" hidden>
      <h1 id="login-title" class="noSelect">Bienvenue sur Kohr !</h1>
      <div id="login-background">
        <label id="login-label" class="noSelect">Pseudo :<input id="login-pseudo-input" autocomplete="off" placeholder="Jean-Kévin"/></label>
        <input id="login-submit-fullscreen" class="login-submit" value="C'est parti !" type="button"/>
        <input id="login-submit-normal" class="login-submit" value="Jouer sans plein écran" type="button"/>
      </div>
    </div>
    
    <div id="lobby-frame" hidden>
      <h1 id="lobby-title" class="noSelect">Partie : </h1>
      <p id="lobby-gamemode" class="noSelect">Mode : </p>
      <p id="lobby-player-list-label" class="noSelect">Joueurs</p>
      <ul id="lobby-player-list"></ul>
    </div>

    <div id="game-frame" hidden>
      <div id="game-base-grid">
        <canvas id="game-base-canvas" height="210" width="410"></canvas>
        <ul id="game-base-entities">

        </ul>
      </div>
      <div id="game-middle-grid">
      </div>
    </div>

    <div id="testing-frame" hidden>
      <input id="testing" value='socket.emit("buildingBuild",{lastTimeStamp:0,atMiddle:false,type:"Wall",x:2,y:2})'/>
      <input id="testing-validate" value="Valider" type="button"/>
    </div>

    <script>
      $(document).ready(function() {
        var socket = io();
        pseudo = "#-1";

        socket.on("disconnect",function(){
          $("#disconnected-frame").attr("hidden",false);
          $("#login-frame").attr("hidden",true);
        });

        socket.on("fatalError",function(data){
          alert("Fatal error : " + data.text)
          document.location.reload(false);
        })
        
        socket.on("logError",function(data){
          console.log("Warning : " + data.text)
        })

        socket.on("showError",function(data){
          alert(data.text)
        })

        socket.on("setTempName",function(data){
          pseudo = data.tempName
          $("#disconnected-frame").attr("hidden",true);
          $("#login-frame").attr("hidden",false);
        });

        socket.on("showLobby",function(data){
          $("#lobby-title").text("Partie : " + data.gameInfo.name)
          $("#lobby-gamemode").text("Mode : " + data.gameInfo.maxPlayers/2 + "vs" + data.gameInfo.maxPlayers/2)
          $("#lobby-player-list").empty()
          data.players.forEach(player =>
            $("#lobby-player-list").append("<li class='lobby-players'>" + player.pseudo + "</li>")
          )
          $("#login-frame").attr("hidden",true);
          $("#lobby-frame").attr("hidden",false);
        });
        
        socket.on("showGamePlay",function(data){
          console.log(data)
        })
        
        socket.on("showGameWait",function(data){
          console.log(data)
        })

        $(".login-submit").click(function() {
          enteredPseudo = $("#login-pseudo-input").val()
          setLandscape()
          if(pseudo == "#-1"){
            document.location.reload(false);
          }
          if(/^[a-z0-9]*$/.test(enteredPseudo)){
            socket.emit("joinSession",{pseudo : enteredPseudo, tempName : pseudo});
            pseudo = enteredPseudo
            if(this.id == "login-submit-fullscreen"){
              var body = document.getElementById("body")
              if (body.requestFullscreen) {
                body.requestFullscreen();
              } else if (body.webkitRequestFullscreen) { /* Safari */
                body.webkitRequestFullscreen();
              } else if (body.msRequestFullscreen) { /* IE11 */
                body.msRequestFullscreen();
              }
            }
          }
        })

        $("#testing-validate").click(function(){
          eval($("#testing").val())
        })

        /*var baseCanvas = document.getElementById("game-base-canvas")
        var height = 200
        var width = 400
        var m = 5
        baseCanvas.height = height + (2*m)
        baseCanvas.width = width + (2*m)
        var baseCtx = baseCanvas.getContext("2d");
        baseCtx.strokeStyle = "#dddddd"
        baseCtx.lineCap = "round";
        baseCtx.lineWidth = 4;
        grid = 9
        heightGrid = height / 2 / grid
        widthGrid = width / 2 / grid
        var xS = width / 2
        var yS = 0
        var xE = width
        var yE = height / 2
        for(let i = 0; i <= grid; i++){
          baseCtx.moveTo(xS+m,yS+m)
          baseCtx.lineTo(xE+m,yE+m)
          baseCtx.stroke()
          xS -= widthGrid
          yS += heightGrid
          xE -= widthGrid
          yE += heightGrid
        }
        var xS = 0
        var yS = height / 2
        var xE = width / 2
        var yE = 0
        for(let i = 0; i <= grid; i++){
          baseCtx.moveTo(xS+m,yS+m)
          baseCtx.lineTo(xE+m,yE+m)
          baseCtx.stroke()
          xS += widthGrid
          yS += heightGrid
          xE += widthGrid
          yE += heightGrid
        }*/
      });

    </script>
  </body>
</html>
